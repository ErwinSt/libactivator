uname_s := $(shell uname -s)
-include $(FRAMEWORKDIR)/makefiles/platform/$(uname_s).mk
export CC CXX STRIP CODESIGN_ALLOCATE

LDFLAGS:=-lobjc -framework Foundation -framework CoreFoundation -multiply_defined suppress \
	-dynamiclib -Wall -Werror -ObjC++ -fobjc-exceptions \
	-fobjc-call-cxx-cdtors -lsubstrate $(LDFLAGS) $(SDKFLAGS)

ifdef DEBUG
DEBUG_CFLAGS=-DDEBUG -ggdb
STRIP=:
endif

CFLAGS:=$(SDKFLAGS) -O2 $(CFLAGS) $(DEBUG_CFLAGS) -I$(FRAMEWORKDIR)/include -include $(FRAMEWORKDIR)/Prefix.pch -Wall -Werror
export FRAMEWORKDIR CFLAGS SDKFLAGS

OFILES=Hook.o

TARGET=$(tweak).dylib

.PHONY: all clean package-local
.PHONY: project-all project-clean project-package-local project-package-post

all: $(TARGET)
	@$(MAKE) project-all #|| true
	@(for i in $(subdirs); do $(MAKE) -C $$i $@; done)

$(TARGET): $(OFILES)
	$(CXX) $(LDFLAGS) -o $@ $^
	$(STRIP) -x $@
	CODESIGN_ALLOCATE=$(CODESIGN_ALLOCATE) ldid -S $@

include $(FRAMEWORKDIR)/makefiles/rules.make

clean:
	rm -f *.o $(TARGET)
	@$(MAKE) project-clean #|| true
	@(for i in $(subdirs); do $(MAKE) -C $$i $@; done)

include $(FRAMEWORKDIR)/makefiles/DebMakefile

package-local: $(TARGET)
	cp $(TARGET) _/Library/MobileSubstrate/DynamicLibraries
	@$(MAKE) project-package-local #|| true
	$(FAKEROOT) chown 0.80 _ -R
	@$(MAKE) project-package-post #|| true

%:: ;
