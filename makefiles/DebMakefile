IP=root@ipod
FAKEROOT:=$(FW_SCRIPTDIR)/fakeroot.sh -p "$(TOP_DIR)/.debmake/fakeroot"

export TOP_DIR
PACKAGE_STAGING_DIR := $(TOP_DIR)/_
export PACKAGE_STAGING_DIR

PACKAGE := $(shell grep Package layout/DEBIAN/control | cut -d' ' -f2)
ARCH := $(shell grep Architecture layout/DEBIAN/control | cut -d' ' -f2)
VERSION := $(shell grep Version layout/DEBIAN/control | cut -d' ' -f2)

BUILDNUM = $(shell TOP_DIR="$(TOP_DIR)" $(FW_SCRIPTDIR)/deb_build_num.sh $(PACKAGE) $(VERSION))
DEBVERSION = $(shell grep Version _/DEBIAN/control | cut -d' ' -f2)

ifdef STOREPACKAGE
FILENAME = cydiastore_$(PACKAGE)_v$(DEBVERSION).deb
else
FILENAME = $(PACKAGE)_$(DEBVERSION)_$(ARCH).deb
endif

.PHONY: install appinstall package-pre package-build package-clean package-local package

install-base:
	scp $(FILENAME) $(IP):
	ssh $(IP) dpkg -i $(FILENAME)

install: install-base
	ssh $(IP) killall -HUP SpringBoard
	
appinstall: install-base
	ssh $(IP) su mobile -c uicache
	
voidinstall: install-base

package-pre: all
	rm -rf $(PACKAGE_STAGING_DIR)
	svn export layout $(PACKAGE_STAGING_DIR) || cp -r layout $(PACKAGE_STAGING_DIR)
	sed -i x -e 's/Version: \(.*\)/Version: \1-$(BUILDNUM)/g' $(PACKAGE_STAGING_DIR)/DEBIAN/control
	$(FAKEROOT) -c

package-build:
	echo "Installed-Size: $(shell du -ks _ | cut -f 1)" >> $(PACKAGE_STAGING_DIR)/DEBIAN/control
	$(FAKEROOT) -r dpkg-deb -b $(PACKAGE_STAGING_DIR) $(FILENAME)

package-clean:
	rm -f $(PACKAGE)_*.deb cydiastore_*.deb

package: package-pre package-local package-build
